name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: uv sync

    # --- ZMIANA: GENERUJEMY 2500 OCEN (50x50) ---
    - name: Create Massive Dummy Data
      run: |
        mkdir -p data/raw
        uv run python -c "
        import pandas as pd
        import random

        # 1. Generujemy 50 film√≥w (ID 1-50)
        # To da nam pewno≈õƒá, ≈ºe mamy 'masƒô'
        movies_data = {
            'movieId': list(range(1, 51)),
            'title': [f'Movie {i}' for i in range(1, 51)],
            'genres': ['Comedy|Action' for _ in range(50)]
        }
        pd.DataFrame(movies_data).to_csv('data/raw/movies.csv', index=False)

        # 2. Generujemy 'Pe≈ÇnƒÖ Macierz' (Dense Matrix)
        # 50 u≈ºytkownik√≥w x 50 film√≥w = 2500 ocen.
        # Ka≈ºdy film bƒôdzie mia≈Ç 50 ocen. Ka≈ºdy user 50 ocen.
        # To musi przej≈õƒá przez filtry.
        ratings = []
        for user_id in range(1, 51):
            for movie_id in range(1, 51):
                # Losowa ocena 3.0 - 5.0
                rating = round(random.uniform(3.0, 5.0), 1)
                ratings.append([user_id, movie_id, rating, 964982703])
        
        pd.DataFrame(ratings, columns=['userId', 'movieId', 'rating', 'timestamp']).to_csv('data/raw/ratings.csv', index=False)
        print(f'‚úÖ Generated MASSIVE data: {len(ratings)} ratings')
        "

    - name: Debug - Check Files
      run: ls -R data/raw

    - name: Generate Model
      run: |
        PYTHONPATH=. uv run python -c "from src.dataprocessing import load_and_process; from src.recommender import MovieRecommender; from pathlib import Path; df=load_and_process(); print(f'DATA SHAPE: {df.shape}'); rec=MovieRecommender(); rec.fit(df); rec.save(Path('model_v1.joblib')); print('‚úÖ Model generated')"

    - name: Build Docker Image
      run: docker build -t movie-recommender:ci .
    - name: üîç Debug - Poka≈º strukturƒô plik√≥w
      run: docker run --rm movie-recommender:ci ls -R /app
    - name: Run Tests inside Docker
      run: docker run --rm movie-recommender:ci /app/.venv/bin/pytest tests/test_api.py -v